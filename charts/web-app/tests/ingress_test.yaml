suite: ingress
templates:
  - templates/ingress.yaml
tests:
  - it: should not render when hostnames is empty
    set:
      name: myapp
      image.repository: nginx
    asserts:
      - hasDocuments:
          count: 0

  - it: should render IngressRoute for string hostname
    set:
      name: myapp
      image.repository: nginx
      hostnames:
        - "myapp"
    asserts:
      - isKind:
          of: IngressRoute
      - isAPIVersion:
          of: traefik.io/v1alpha1
      - equal:
          path: metadata.name
          value: web-app-myapp

  - it: should use websecure entrypoint
    set:
      name: myapp
      image.repository: nginx
      hostnames:
        - "myapp"
    asserts:
      - contains:
          path: spec.entryPoints
          content: websecure

  - it: should set TLS secret name
    set:
      name: myapp
      image.repository: nginx
      hostnames:
        - "myapp"
    asserts:
      - equal:
          path: spec.tls.secretName
          value: web-app-myapp-tls

  - it: should generate PathPrefix route for string hostname
    set:
      name: myapp
      image.repository: nginx
      hostnames:
        - "myapp"
    asserts:
      - equal:
          path: spec.routes[0].match
          value: "Host(`myapp`) && PathPrefix(`/`)"

  - it: should generate Path route for exact path type
    set:
      name: myapp
      image.repository: nginx
      hostnames:
        - "myapp":
            paths:
              - path: /api
                type: exact
    asserts:
      - equal:
          path: spec.routes[0].match
          value: "Host(`myapp`) && Path(`/api`)"

  - it: should generate PathRegexp route for regex path type
    set:
      name: myapp
      image.repository: nginx
      hostnames:
        - "myapp":
            paths:
              - path: /v[0-9]+
                type: regex
    asserts:
      - equal:
          path: spec.routes[0].match
          value: "Host(`myapp`) && PathRegexp(`/v[0-9]+`)"

  - it: should use Service for rolling strategy
    set:
      name: myapp
      image.repository: nginx
      hostnames:
        - "myapp"
    asserts:
      - equal:
          path: spec.routes[0].services[0].kind
          value: Service

  - it: should use TraefikService for canary strategy
    set:
      name: myapp
      image.repository: nginx
      hostnames:
        - "myapp"
      rollout.strategy: canary
    asserts:
      - equal:
          path: spec.routes[0].services[0].kind
          value: TraefikService
